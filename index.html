
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Visualizzatore di documenti</title>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: rgb(217,234,211);
    margin: 0;
    padding: 20px;
    height: 100vh;
    overflow: hidden;
}

/* LOGO */
.logo-area {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.logo-area img {
    max-height: 150px;
    border-radius: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

#btnAccesso {
    width: 150px;
    padding: 10px 0;
    border-radius: 10px;
    border: 2px solid black;
    background-color: white;
    font-weight: bold;
    cursor: pointer;
}

/* PAGINA PRINCIPAL */
.main-container {
    display: flex;
    flex-direction: column;
    max-width: 1000px;
    width: 100%;
    margin-left: 260px;
    gap: 20px;
}

h1 { margin: 0; font-size: 28px; }

#busca {
    padding: 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 2px solid black;
    width: 100%;
    background-color: white;
}

.table-wrapper {
    max-height: 500px;
    overflow-y: auto;
    border: 2px solid black;
    border-radius: 10px;
}

table { width: 100%; border-collapse: collapse; table-layout: fixed; }

th, td {
    border: 1px solid black;
    padding: 8px;
    font-size: 14px;
    text-align: left;
    word-wrap: break-word;
}

th {
    background-color: #e0e0e0;
    position: sticky;
    top: 0;
}

#tabela th:nth-child(1),
#tabela td:nth-child(1) { width: 20%; }
#tabela th:nth-child(2),
#tabela td:nth-child(2) { width: 20%; }
#tabela th:nth-child(3),
#tabela td:nth-child(3) { width: 60%; }

tbody tr:nth-child(odd) { background-color: white; }
tbody tr:nth-child(even) { background-color: rgb(230,245,230); }
tbody tr:hover { background-color: #a8cfff; }

/* LOGIN */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-box {
    background: #e0e0e0;
    padding: 25px;
    border-radius: 15px;
    width: 350px;
    text-align: center;
}

.modal-box select,
.modal-box input {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 2px solid black;
}

/* TELA APROVADOR */
.pagina-aprovador {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgb(217,234,211);
    padding: 40px;
}

#paginaAprovador .logo-area button {
    display: none;
}
</style>
</head>

<body>

<div class="logo-area">
    <img src="Logotipo.png">
    <button id="btnAccesso">Accesso approvatori</button>
</div>

<div class="main-container" id="paginaPrincipal">
    <h1>Visualizzatore di documenti</h1>
    <input type="text" id="busca" placeholder="">

    <div class="table-wrapper">
        <table id="tabela">
            <thead>
                <tr>
                    <th>Settore</th>
                    <th>Tipo</th>
                    <th>Descrizione</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- LOGIN -->
<div id="loginModal" class="modal">
  <div class="modal-box">
    <h3>Accesso approvatori</h3>
    <select id="listaUsuarios"></select>
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <button onclick="fecharLogin()">Cancelar</button>
  </div>
</div>

<!-- APROVADOR -->
<div id="paginaAprovador" class="pagina-aprovador">
    <div class="logo-area">
        <img src="Logotipo.png">
    </div>

    <h1>Area approvatori</h1>
    <p id="userLogado"></p>
    <button onclick="logout()">Logoff / Retornar</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<script>
/* ===== PARTE ORIGINAL (RESTORED) ===== */

let dati = [];

function normalize(text) {
    return text.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]/g, " ")
        .toLowerCase();
}

function mapColumns(item) {
    return {
        Settore: item.Setor || "",
        Tipo: item.Tipo || "",
        Descrizione: item.Descricao || "",
        Link: item.Link || ""
    };
}

Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSNd8ngFjnAI7X8Kwh-uxCveqFJv85CaFcjLD7S8aKSXVITSqyOyCQ9C5y1CIjX8t4uqtt7FFuQ1d7O/pub?output=csv", {
    download: true,
    header: true,
    complete: function(results) {
        dati = results.data.map(mapColumns);
    }
});

document.getElementById("busca").addEventListener("keyup", function() {
    const filtro = normalize(this.value);

    if (!filtro) {
        aggiornaTabella([]);
        return;
    }

    const filtrato = dati.filter(item =>
        normalize(item.Settore).includes(filtro) ||
        normalize(item.Tipo).includes(filtro) ||
        normalize(item.Descrizione).includes(filtro)
    );

    aggiornaTabella(filtrato);
});

function aggiornaTabella(lista) {
    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = "";

    lista.forEach(item => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${item.Settore}</td>
            <td>${item.Tipo}</td>
            <td>${item.Descrizione}</td>
        `;

        if (item.Link) {
            let linkFinale = item.Link;
            if (linkFinale.includes("drive.google.com")) {
                const fileId = linkFinale.split("/d/")[1].split("/")[0];
                linkFinale = `https://drive.google.com/file/d/${fileId}/preview`;
            }

            tr.style.cursor = "pointer";
            tr.onclick = () => window.open(linkFinale, "_blank");
        }

        tbody.appendChild(tr);
    });
}

/* ===== LOGIN ===== */

const URL_ASSISTENTE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSNd8ngFjnAI7X8Kwh-uxCveqFJv85CaFcjLD7S8aKSXVITSqyOyCQ9C5y1CIjX8t4uqtt7FFuQ1d7O/pub?gid=1082523786&single=true&output=csv";
let credenciais = [];

Papa.parse(URL_ASSISTENTE, {
    download: true,
    complete: function(results) {
        const select = document.getElementById("listaUsuarios");
        const linhas = results.data.slice(1);

        linhas.forEach(l => {
            if(l[0] && l[1]){
                credenciais.push({u:l[0].trim(), p:l[1].trim()});
                const opt=document.createElement("option");
                opt.value=l[0]; opt.textContent=l[0];
                select.appendChild(opt);
            }
        });
    }
});

document.getElementById("btnAccesso").onclick = () => {
    document.getElementById("listaUsuarios").value = "";
    document.getElementById("senha").value = "";
    document.getElementById("loginModal").style.display = "flex";
};

function fecharLogin(){document.getElementById("loginModal").style.display="none";}
function logout(){ location.reload(); }

function fazerLogin(){
    const u=document.getElementById("listaUsuarios").value;
    const p=document.getElementById("senha").value;

    const ok=credenciais.find(x=>x.u===u&&x.p===p);
    if(ok){
        document.getElementById("loginModal").style.display="none";
        document.getElementById("paginaPrincipal").style.display="none";
        document.getElementById("paginaAprovador").style.display="block";
        document.getElementById("userLogado").textContent="Utente: "+u;
    } else alert("Credenziali errate");
}
</script>

</body>
</html>
