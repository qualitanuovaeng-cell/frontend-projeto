<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Visualizzatore di documenti</title>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: rgb(217,234,211);
    margin: 0;
    padding: 20px;
    height: 100vh;
    overflow: hidden;
}

/* LOGO */
.logo-area {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.logo-area img {
    max-height: 150px;
    border-radius: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

#btnAccesso {
    width: 150px;
    padding: 10px 0;
    border-radius: 10px;
    border: 2px solid black;
    background-color: white;
    font-weight: bold;
    cursor: pointer;
}

/* PALCO PRINCIPAL */
.main-container {
    display: flex;
    flex-direction: column;
    max-width: 1000px;
    width: 100%;
    margin-left: 260px;
    gap: 10px;
}

h1 { margin: 0; font-size: 28px; }

/* BUSCA */
.search-wrapper {
    border: 2px solid black;
    border-radius: 10px;
    padding: 2px;
    background-color: white;
}

#busca {
    padding: 10px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
    border: none;
    outline: none;
    background-color: white;
}

/* TABELA */
.table-wrapper {
    max-height: 500px;
    overflow-y: auto;
    border: 2px solid black;
    border-radius: 10px;
}

table { width: 100%; border-collapse: collapse; table-layout: fixed; }

th, td {
    border: 1px solid black;
    padding: 8px;
    font-size: 14px;
    text-align: left;
    word-wrap: break-word;
}

th {
    background-color: #e0e0e0;
    position: sticky;
    top: 0;
}

#tabela th:nth-child(1),
#tabela td:nth-child(1) { width: 20%; }
#tabela th:nth-child(2),
#tabela td:nth-child(2) { width: 20%; }
#tabela th:nth-child(3),
#tabela td:nth-child(3) { width: 60%; }

tbody tr:nth-child(odd) { background-color: white; }
tbody tr:nth-child(even) { background-color: rgb(230,245,230); }
tbody tr:hover { background-color: #a8cfff; }

/* LOGIN */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.modal-box {
    background: #e0e0e0;
    padding: 25px;
    border-radius: 15px;
    width: 350px;
    text-align: center;
}

.modal-box select,
.modal-box input {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 2px solid black;
}

/* TELA APROVADOR */
.pagina-aprovador {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgb(217,234,211);
    padding: 40px;
}

.pagina-aprovador .aprovador-container {
    margin-top: 200px;
    max-width: 1000px;
    margin-left: 260px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

#paginaAprovador #btnAccesso {
    display: none;
}

#btnRetornar {
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid black;
    background-color: white;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>

<body>

<div class="logo-area">
    <img src="Logotipo.png">
    <button id="btnAccesso">Accesso approvatori</button>
</div>

<div class="main-container" id="paginaPrincipal">
    <h1>Visualizzatore di documenti</h1>

    <div class="search-wrapper">
        <input
            type="text"
            id="busca"
            placeholder="Digitare per cercare..."
            autocomplete="off">
    </div>

    <div class="table-wrapper">
        <table id="tabela">
            <thead>
                <tr>
                    <th>Settore</th>
                    <th>Tipo</th>
                    <th>Descrizione</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- LOGIN -->
<div id="loginModal" class="modal">
  <div class="modal-box">
    <h3>Accesso approvatori</h3>
    <select id="listaUsuarios"></select>
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <button onclick="fecharLogin()">Cancelar</button>
  </div>
</div>

<!-- PAGINA APROVADOR -->
<div id="paginaAprovador" class="pagina-aprovador">
    <div class="logo-area">
        <img src="Logotipo.png">
    </div>

    <div class="aprovador-container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h1>Area approvatori</h1>
                <p id="userLogado"></p>
            </div>
            <button id="btnRetornar" onclick="logout()">Retornar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

<script>
/* PARTE ORIGINAL */

let dati = [];

function normalize(text) {
    return text.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]/g, " ")
        .toLowerCase();
}

function mapColumns(item) {
    return {
        Settore: item.Setor || "",
        Tipo: item.Tipo || "",
        Descrizione: item.Descricao || "",
        Link: item.Link || ""
    };
}

Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vSNd8ngFjnAI7X8Kwh-uxCveqFJv85CaFcjLD7S8aKSXVITSqyOyCQ9C5y1CIjX8t4uqtt7FFuQ1d7O/pub?output=csv", {
    download: true,
    header: true,
    complete: r => dati = r.data.map(mapColumns)
});

document.getElementById("busca").addEventListener("keyup", function () {
    const filtro = normalize(this.value);
    if (!filtro) return updateTable([]);
    updateTable(dati.filter(i =>
        normalize(i.Settore).includes(filtro) ||
        normalize(i.Tipo).includes(filtro) ||
        normalize(i.Descrizione).includes(filtro)
    ));
});

function updateTable(lista){
    const tb=document.querySelector("#tabela tbody");
    tb.innerHTML="";
    lista.forEach(item=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${item.Settore}</td><td>${item.Tipo}</td><td>${item.Descrizione}</td>`;
        if(item.Link){
            let link=item.Link;
            if(link.includes("drive.google.com")){
                const id=link.split("/d/")[1].split("/")[0];
                link=`https://drive.google.com/file/d/${id}/preview`;
            }
            tr.style.cursor="pointer";
            tr.onclick=()=>window.open(link,"_blank");
        }
        tb.appendChild(tr);
    });
}

/* LOGIN */

const URL_ASSISTENTE="https://docs.google.com/spreadsheets/d/e/2PACX-1vSNd8ngFjnAI7X8Kwh-uxCveqFJv85CaFcjLD7S8aKSXVITSqyOyCQ9C5y1CIjX8t4uqtt7FFuQ1d7O/pub?gid=1082523786&single=true&output=csv";

let credenciais=[];

Papa.parse(URL_ASSISTENTE,{
    download:true,
    complete:r=>{
        const sel=document.getElementById("listaUsuarios");
        r.data.slice(1).forEach(l=>{
            if(l[0]&&l[1]){
                credenciais.push({u:l[0].trim(),p:l[1].trim()});
                const o=document.createElement("option");
                o.value=l[0];o.textContent=l[0];
                sel.appendChild(o);
            }
        });
    }
});

document.getElementById("btnAccesso").onclick=()=>{
    document.getElementById("listaUsuarios").value="";
    document.getElementById("senha").value="";
    document.getElementById("loginModal").style.display="flex";
}

function fecharLogin(){
    document.getElementById("loginModal").style.display="none";
}

function fazerLogin(){
    const u=document.getElementById("listaUsuarios").value;
    const p=document.getElementById("senha").value;
    const ok=credenciais.find(x=>x.u===u&&x.p===p);
    if(ok){
        document.getElementById("loginModal").style.display="none";
        document.getElementById("paginaPrincipal").style.display="none";
        document.getElementById("paginaAprovador").style.display="block";
        document.getElementById("userLogado").textContent="Utente: "+u;
    }else alert("Credenziali errate");
}

function logout(){
    location.reload();
}
</script>

</body>
</html>
